<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‚Äî StudyBoard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styledas.css" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --card-bg: #f9fafb;
      --border: #e5e7eb;
      --accent: #3b82f6;
      --danger: #ef4444;
      --success: #10b981;
      --warn: #f59e0b;
    }
    html[data-theme="dark"] {
      --bg: #0b1220;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --card-bg: #0f172a;
      --border: #1f2937;
      --accent: #60a5fa;
      --danger: #f87171;
      --success: #34d399;
      --warn: #fbbf24;
    }

    body { background: var(--bg); color: var(--text); }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .muted { color: var(--muted); }

    /* ---- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô + ‡πÄ‡∏á‡∏≤‡∏≠‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) ---- */
    .btn {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 8px 14px;
      cursor: pointer;
      background: var(--accent);
      color:#fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      transition: transform .06s ease, box-shadow .12s ease, background-color .12s ease, filter .12s ease;
    }
    .btn.tiny { font-size: 12px; padding: 6px 12px; border-radius: 14px; }
    .btn.ghost { background: rgba(0,0,0,0.02); color: var(--text); }
    html[data-theme="dark"] .btn.ghost { background: rgba(255,255,255,0.06); }
    .btn.success { background: var(--success); border-color: var(--success); }
    .btn.danger  { background: var(--danger);  border-color: var(--danger); }
    .btn.warn    { background: var(--warn);    border-color: var(--warn); }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,.08); filter: brightness(1.04); }
    .btn:active { transform: translateY(0); box-shadow: 0 1px 4px rgba(0,0,0,.08); }

    .icon-btn, .menu-btn { color: var(--text); }

    .opt.grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 8px; align-items: start;
    }
    .controls.grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px; align-items: center;
    }
    .plan-list { list-style: none; margin: 0; padding: 0; }
    .plan-item { display: flex; justify-content: space-between; align-items: stretch; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .plan-item:last-child { border-bottom: none; }
    .plan-info { flex: 1; }
    .row1 { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; }
    .row2 { margin-top: 4px; }
    .plan-item.done .plan-title { text-decoration: line-through; opacity: .6; }
    .plan-actions { display: flex; gap: 10px; padding-right: 6px; } /* ‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤ */
    .plan-actions .btn { min-width: 82px; border-radius: 16px; }   /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏µ‡∏ö‡∏à‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏´‡∏≤‡∏¢ */

    .inline-edit { border-bottom: 1px dashed var(--border); cursor: text; }
    .tag { padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; font-size: 12px; }
    .tag.prio-‡∏™‡∏π‡∏á { background: rgba(245,158,11,.15); border-color: var(--warn); }
    .tag.prio-‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å { background: rgba(239,68,68,.15); border-color: var(--danger);}

    .stat { display:flex; gap: 12px; flex-wrap: wrap; }
    .stat .chip { background: var(--card-bg); border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; }

    input[type="search"], select, input[type="date"], input[type="text"], textarea {
      background: transparent; border: 1px solid var(--border); color: var(--text);
      border-radius: 10px; padding: 6px 10px;
    }
    textarea { resize: vertical; }

    .empty { color: var(--muted); padding: 12px 0; }

    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å container */
    .plan-item, .plan-actions, .card { overflow: visible; }
  </style>
</head>

<script>
  // ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å sidebar
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.menu-btn');
    if (!btn) return;
    const href = btn.getAttribute('data-href');
    if (href) window.location.href = href;
  });
</script>

<body class="has-sidebar">

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">‚ò∞</button>
    
    <div class="sidebar-tools">
      <button class="menu-btn theme-toggle" id="themeToggle" type="button" aria-label="Switch color theme" aria-pressed="false">
        <span class="icon" id="themeIcon">üåì</span>
        <span class="label" id="themeLabel">‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°</span>
      </button>

      <div class="sidebar-profile" id="sidebarProfile">
        <img src="‡πÇ‡∏õ‡∏£.jpg" alt="Profile" class="avatar" />
        <div class="profile-meta">
          <div class="profile-name">My Profile</div>
          <div class="profile-sub">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡∏¥‡∏î üìö</div>
        </div>
      </div>

      <script>
        document.getElementById("sidebarProfile").addEventListener("click", () => {
          window.location.href = "user.html";
        });
      </script>

      <button class="icon-btn logout-icon" id="logoutBtn" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" aria-label="Logout">üö™</button>
    </div>

    <div class="sidebar-title">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</div>
    <ul class="menu">
      <li class="menu-item">
        <button class="menu-btn" data-href="dashboard.html">
          <span class="icon">üè†</span>
          <span class="label">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </button>
      </li>
      <li class="menu-item">
        <button class="menu-btn" data-href="reading-plan.html">
          <span class="icon">üìö</span>
          <span class="label">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</span>
        </button>
      </li>
      <li class="menu-item">
        <button class="menu-btn" data-href="success.html">
          <span class="icon">‚úÖ</span>
          <span class="label">‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
        </button>
      </li>
      <li class="menu-sep"></li>
      <li class="menu-item add">
        <button class="btn tiny success menu-btn" data-href="new-reading.html">
          <span class="icon">‚ûï</span>
          <span class="label">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡πà‡∏≤‡∏ô</span>
        </button>
      </li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="main">
    <header class="topbar">
      <h1>üìå ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h1>
    </header>

    <div class="container">
      <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
      <section class="card">
        <div class="controls grid">
          <input type="search" id="q" placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡πÇ‡∏ô‡πâ‡∏ï/‡∏ß‡∏¥‡∏ä‡∏≤‚Ä¶" />
          <select id="fPriority">
            <option value="">‡∏Å‡∏£‡∏≠‡∏á: ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
            <option>‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡∏™‡∏π‡∏á</option><option>‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          </select>
          <input type="text" id="fSubject" placeholder="‡∏Å‡∏£‡∏≠‡∏á: ‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå)" />
          <select id="sortBy">
            <option value="date-asc">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏Å‡πà‡∏≤‚Üí‡πÉ‡∏´‡∏°‡πà)</option>
            <option value="date-desc">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏´‡∏°‡πà‚Üí‡πÄ‡∏Å‡πà‡∏≤)</option>
            <option value="prio-desc">‚≠ê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô)</option>
            <option value="title-asc">üî§ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏Å-‡∏Æ)</option>
          </select>
          <div style="display:flex; gap:8px;">
            <button class="btn ghost tiny" id="clearFilters">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            <button class="btn warn tiny" id="exportBtn">üì§ Export</button>
            <label class="btn ghost tiny" for="importFile">üì• Import</label>
            <input type="file" id="importFile" accept=".json,application/json" style="display:none" />
          </div>
        </div>
      </section>

      <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡∏°‡πà -->
      <section class="card add-plan">
        <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</h2>
        <div class="opt grid">
          <input type="text" id="bookTitle" placeholder="üìñ ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏ö‡∏ó/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠..." aria-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" />
          <input type="date" id="planDate" aria-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô" />
        
          <select id="priority" aria-label="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç">
            <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‚≠ê ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="‡∏™‡∏π‡∏á">üî• ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏π‡∏á</option>
            <option value="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">üö® ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          </select>
          <input type="text" id="subject" placeholder="üè∑Ô∏è ‡∏ß‡∏¥‡∏ä‡∏≤/‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå, ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)" aria-label="‡∏ß‡∏¥‡∏ä‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏ß‡∏î" />
          <textarea id="notes" rows="2" placeholder="üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 25‚Äì35, ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2"></textarea>

          <button class="btn success tiny" id="addPlanBtn">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </section>

      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
      <section class="card">
        <div class="stat" id="stats"></div>
      </section>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô -->
      <section class="card">
        <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</h2>
        <ul class="plan-list" id="planList"></ul>
      </section>
    </div>
  </main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ================== THEME ================== */
  const themeToggle = document.getElementById("themeToggle");
  const themeIcon   = document.getElementById("themeIcon");
  const themeLabel  = document.getElementById("themeLabel");
  const THEME_KEY = "sb_theme";
  function getPreferredTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    if (saved === "light" || saved === "dark") return saved;
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }
  function applyTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    const isDark = theme === "dark";
    themeToggle.setAttribute("aria-pressed", String(isDark));
    themeIcon.textContent = isDark ? "üåô" : "üåû";
    themeLabel.textContent = isDark ? "‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á" : "‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°";
  }
  applyTheme(getPreferredTheme());
  const media = window.matchMedia("(prefers-color-scheme: dark)");
  media.addEventListener?.("change", e => { if (!localStorage.getItem(THEME_KEY)) applyTheme(e.matches ? "dark" : "light"); });
  themeToggle.addEventListener("click", () => {
    const current = document.documentElement.getAttribute("data-theme") || "light";
    const next = current === "light" ? "dark" : "light";
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  });

  /* ================== ELEMENTS ================== */
  const titleEl = document.getElementById("bookTitle");
  const dateEl  = document.getElementById("planDate");
  const prioEl  = document.getElementById("priority");
  const subjEl  = document.getElementById("subject");
  const notesEl = document.getElementById("notes");
  const addBtn  = document.getElementById("addPlanBtn");

  const listEl  = document.getElementById("planList");
  const qEl = document.getElementById("q");
  const fPriorityEl = document.getElementById("fPriority");
  const fSubjectEl = document.getElementById("fSubject");
  const sortEl = document.getElementById("sortBy");
  const statsEl = document.getElementById("stats");
  const exportBtn = document.getElementById("exportBtn");
  const importFile = document.getElementById("importFile");

  /* ================== STORAGE ================== */
  const STORAGE_KEY = "studyboard_reading_plans";
  const META_KEY = "studyboard_meta";
  let plans = []; try { plans = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch {}
  let meta = { streakDays: 0, lastReadDate: null }; try { meta = Object.assign(meta, JSON.parse(localStorage.getItem(META_KEY)) || {}); } catch {}
  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(plans)); }
  function saveMeta() { localStorage.setItem(META_KEY, JSON.stringify(meta)); }

  /* ================== UTIL ================== */
  function formatDate(iso) { if (!iso) return ""; const [y,m,d] = iso.split("-"); return `${d}/${m}/${y}`; }
  function escapeHtml(s) { const t=document.createElement("div"); t.innerText=s; return t.innerHTML; }
  function prioRank(p){ return p==="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å" ? 3 : p==="‡∏™‡∏π‡∏á" ? 2 : 1; }
  function todayISO(){ const now=new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,"0"); const d=String(now.getDate()).padStart(2,"0"); return `${y}-${m}-${d}`; }
  function dayDiff(isoA, isoB){ const a = new Date(isoA+"T00:00:00"); const b = new Date(isoB+"T00:00:00"); return Math.round((b - a) / (24*3600*1000)); }

  /* ================== RENDER ================== */
  function renderStats(view) {
    const today = todayISO();
    const todayCount = view.filter(p => p.date === today).length;
    const weekWindow = 7 * 24 * 60 * 60 * 1000;
    const nowTs = Date.now();
    const weekCount = view.filter(p => {
      if (!p.date) return false;
      const ts = Date.parse(p.date + "T00:00:00");
      return nowTs - ts <= weekWindow;
    }).length;
    const doneCount = view.filter(p => p.done).length;
    const allCount = view.length;
    statsEl.innerHTML = `
      <span class="chip">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <b>${todayCount}</b> ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
      <span class="chip">üóìÔ∏è 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b>${weekCount}</b> ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
      <span class="chip">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: <b>${doneCount}</b> / ${allCount}</span>
      <span class="chip">üî• Streak ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô: <b>${meta.streakDays}</b> ‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</span>
    `;
  }

  function render() {
    // ‡∏Å‡∏£‡∏≠‡∏á
    let view = plans.filter(p => {
      const q = (qEl.value || "").toLowerCase();
      const inText = !q || [p.title, p.subject, p.notes].some(v => (v||"").toLowerCase().includes(q));
      const prioOk = !fPriorityEl.value || p.priority === fPriorityEl.value;
      const subjOk = !fSubjectEl.value || (p.subject || "").toLowerCase().includes(fSubjectEl.value.toLowerCase());
      return inText && prioOk && subjOk;
    });
    // ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö
    const sort = sortEl.value || "date-asc";
    view.sort((a,b)=>{
      if (sort === "date-asc")  return (a.date||"") > (b.date||"") ? 1 : -1;
      if (sort === "date-desc") return (a.date||"") < (b.date||"") ? 1 : -1;
      if (sort === "prio-desc") return prioRank(b.priority) - prioRank(a.priority);
      if (sort === "title-asc") return (a.title||"").localeCompare((b.title||""), "th");
      return 0;
    });
    // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    renderStats(view);

    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    listEl.innerHTML = "";
    if (view.length === 0) { listEl.innerHTML = `<li class="empty">üò¥ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</li>`; return; }

    view.forEach(p => {
      const idx = plans.indexOf(p);
      const li = document.createElement("li");
      li.className = "plan-item" + (p.done ? " done" : "");

      li.innerHTML = `
        <div class="plan-info">
          <div class="row1">
            <span class="plan-title inline-edit" data-field="title" data-idx="${idx}">üìñ ${escapeHtml(p.title)}</span>
            <span class="plan-date inline-edit" data-field="date" data-idx="${idx}">üóìÔ∏è ${formatDate(p.date)}</span>
            <span class="tag prio-${escapeHtml(p.priority)} inline-edit" data-field="priority" data-idx="${idx}">‚≠ê ${escapeHtml(p.priority||"‡∏õ‡∏Å‡∏ï‡∏¥")}</span>
            ${p.subject ? `<span class="tag inline-edit" data-field="subject" data-idx="${idx}">üè∑Ô∏è ${escapeHtml(p.subject)}</span>` : `<span class="tag inline-edit" data-field="subject" data-idx="${idx}">üè∑Ô∏è +‡∏ß‡∏¥‡∏ä‡∏≤</span>`}
          </div>
          ${p.notes ? `<div class="row2 inline-edit" data-field="notes" data-idx="${idx}">üìù ${escapeHtml(p.notes)}</div>` : `<div class="row2 inline-edit muted" data-field="notes" data-idx="${idx}">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï‚Ä¶</div>`}
        </div>
        <div class="plan-actions">
          <button class="btn tiny"       data-action="done" data-idx="${idx}" aria-label="${p.done ? "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à" : "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"}">
            ${p.done ? "‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à" : "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"}
          </button>
          <button class="btn tiny ghost" data-action="copy" data-idx="${idx}" aria-label="‡∏ó‡∏≥‡∏ã‡πâ‡∏≥">
            üîÅ ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
          </button>
          <button class="btn tiny danger" data-action="del" data-idx="${idx}" aria-label="‡∏•‡∏ö">
            üóëÔ∏è ‡∏•‡∏ö
          </button>
        </div>
      `;
      listEl.appendChild(li);
    });
  }

  /* ================== ADD ================== */
  addBtn.addEventListener("click", async () => {
    const title = (titleEl.value || "").trim();
    const date  = (dateEl.value  || "").trim();
    const priority = prioEl.value || "‡∏õ‡∏Å‡∏ï‡∏¥";
    const subject  = (subjEl.value  || "").trim();
    const notes    = (notesEl.value || "").trim();

    if (!title) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‚úçÔ∏è"); titleEl.focus(); return; }
    if (!date)  { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà üìÖ"); dateEl.focus(); return; }

    const newItem = { title, date, priority, subject, notes, done: false, createdAt: Date.now() };

    plans.push(newItem);
    save();

    // reset ‡∏ü‡∏≠‡∏£‡πå‡∏°
    titleEl.value = ""; dateEl.value = ""; prioEl.value = "‡∏õ‡∏Å‡∏ï‡∏¥"; subjEl.value = ""; notesEl.value = "";
    render();
  });

  /* ================== LIST ACTIONS ================== */
  listEl.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    const act = btn.dataset.action;

    if (act === "del") {
      if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? üóëÔ∏è")) { plans.splice(idx, 1); save(); render(); }
      return;
    }
    if (act === "done") {
      const next = !plans[idx].done;
      plans[idx].done = next;
      save();
      if (next) updateStreakIfRead(plans[idx].date); // ‡∏ô‡∏±‡∏ö streak ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
      render();
      return;
    }
    if (act === "copy") {
      const p = plans[idx];
      const copy = { ...p, done:false, createdAt: Date.now() };
      plans.push(copy); save(); render(); return;
    }
  });

  /* ================== INLINE EDIT ================== */
  listEl.addEventListener("dblclick", (e) => {
    const el = e.target.closest(".inline-edit");
    if (!el) return;
    const idx = Number(el.dataset.idx);
    const field = el.dataset.field;
    const p = plans[idx];
    let val = "";

    if (field === "title") {
      val = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‚úçÔ∏è:", p.title || "");
      if (val !== null) p.title = val.trim();
    } else if (field === "date") {
      val = prompt("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD) üìÖ:", p.date || "");
      if (val !== null) p.date = val.trim();
    } else if (field === "priority") {
      val = prompt("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏õ‡∏Å‡∏ï‡∏¥/‡∏™‡∏π‡∏á/‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å) ‚≠ê:", p.priority || "‡∏õ‡∏Å‡∏ï‡∏¥");
      if (val !== null) p.priority = val.trim();
    } else if (field === "subject") {
      val = prompt("‡∏ß‡∏¥‡∏ä‡∏≤/‡∏´‡∏°‡∏ß‡∏î üè∑Ô∏è:", p.subject || "");
      if (val !== null) p.subject = val.trim();
    } else if (field === "notes") {
      val = prompt("‡πÇ‡∏ô‡πâ‡∏ï üìù:", p.notes || "");
      if (val !== null) p.notes = val.trim();
    }

    save(); render();
  });

  /* ================== FILTERS & SORT ================== */
  document.getElementById("clearFilters").addEventListener("click", () => {
    qEl.value=""; fPriorityEl.value=""; fSubjectEl.value=""; sortEl.value="date-asc"; render();
  });
  qEl.addEventListener("input", render);
  fPriorityEl.addEventListener("change", render);
  fSubjectEl.addEventListener("input", render);
  sortEl.addEventListener("change", render);

  /* ================== EXPORT / IMPORT ================== */
  exportBtn.addEventListener("click", () => {
    const payload = { exportedAt: new Date().toISOString(), plans, meta };
    const payloadStr = JSON.stringify(payload, null, 2);
    const blob = new Blob([payloadStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "reading-plans.json";
    document.body.appendChild(a); a.click();
    a.remove(); URL.revokeObjectURL(url);
  });

  importFile.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data || !Array.isArray(data.plans)) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        plans = data.plans;
        meta = Object.assign({ streakDays: 0, lastReadDate: null }, data.meta || {});
        save(); saveMeta(); render();
        alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ");
      } catch (err) {
        alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message + " ‚ùå");
      } finally {
        importFile.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  });

  /* ================== STREAK ================== */
  function updateStreakIfRead(dateIso){
    if (!dateIso) return;
    const last = meta.lastReadDate;
    const today = todayISO();
    if (dateIso > today) return;
    if (!last) { meta.streakDays = 1; meta.lastReadDate = dateIso; saveMeta(); return; }
    if (dateIso === last) return;
    const diffDays = dayDiff(last, dateIso);
    if (diffDays === 1) meta.streakDays += 1;
    else if (diffDays > 1) meta.streakDays = 1;
    meta.lastReadDate = dateIso; saveMeta();
  }

  /* ================== SIDEBAR TOGGLE ================== */
  const sidebarToggle = document.getElementById("sidebarToggle");
  if (sidebarToggle) { sidebarToggle.addEventListener("click", () => { document.body.classList.toggle("sidebar-collapsed"); }); }

  render();
});
</script>

</body>
</html>
